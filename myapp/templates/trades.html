{% extends 'base.html' %}

{% block title %}Trades - Trading Platform{% endblock %}

{% block extra_css %}
<style>
    .trades-container {
        padding: 20px;
        background: #1a1c25;
        border-radius: 8px;
        margin: 20px;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .action-btn {
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #2a2d3e;
        background: transparent;
        color: #fff;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        background: #2a2d3e;
    }

    .trades-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        color: #fff;
    }

    .trades-table th {
        background: #2a2d3e;
        padding: 12px;
        text-align: left;
        font-weight: 500;
        font-size: 14px;
    }

    .trades-table td {
        padding: 12px;
        border-bottom: 1px solid #2a2d3e;
        font-size: 14px;
    }

    .account-info {
        display: flex;
        gap: 20px;
        margin: 15px 0;
        padding: 10px;
        background: #2a2d3e;
        border-radius: 4px;
    }

    .info-item {
        display: flex;
        gap: 5px;
        align-items: center;
    }

    .info-item span:first-child {
        color: #8a8d98;
    }

    .info-item span:last-child {
        color: #fff;
        font-weight: 500;
    }

    .positive {
        color: #4CAF50;
    }

    .negative {
        color: #f44336;
    }

    .no-orders {
        text-align: center;
        padding: 20px;
        color: #8a8d98;
    }

    .trade-type {
        font-weight: bold;
    }

    .trade-type.buy {
        color: #4CAF50;
    }

    .trade-type.sell {
        color: #f44336;
    }

    /* New styles for Buy/Sell buttons */
    .trade-actions {
        display: flex;
        gap: 8px;
        white-space: nowrap;
        justify-content: center;
    }

    .action-button {
        padding: 6px 10px;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        font-size: 11px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 4px;
        width: auto;
        min-width: 60px;
        max-width: 90px;
        overflow: hidden;
        text-overflow: ellipsis;
        justify-content: center;
    }

    .action-button i {
        font-size: 10px;
    }
    
    .action-button span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .buy-button {
        background: #4CAF50;
    }

    .sell-button {
        background: #f44336;
    }

    .action-button:hover {
        opacity: 0.9;
        transform: scale(1.05);
    }

    .trades-table td:last-child {
        min-width: 80px;
        max-width: 100px;
        width: 100px;
        text-align: center;
    }

    /* Additional modal styles */
    .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        overflow: auto;
    }

    .modal-content {
        background: #1a1c25;
        padding: 25px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: modalFadeIn 0.3s;
    }

    @keyframes modalFadeIn {
        from { opacity: 0; transform: translate(-50%, -55%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
    }

    .close {
        position: absolute;
        right: 20px;
        top: 20px;
        color: #666;
        font-size: 20px;
        font-weight: 500;
        cursor: pointer;
        transition: color 0.2s;
    }

    .close:hover {
        color: #fff;
    }

    .modal h2 {
        color: #fff;
        font-size: 20px;
        margin: 0 0 20px 0;
        font-weight: 500;
    }

    .trade-details {
        background-color: #12151c;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        border: 1px solid #1f2330;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #1f2330;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        color: #888;
        font-size: 14px;
    }

    .detail-value {
        color: #fff;
        font-size: 15px;
        font-weight: 500;
    }

    .quantity-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .quantity-input {
        background: #1f2330;
        border: 1px solid #2a2d3e;
        border-radius: 5px;
        padding: 8px 12px;
        color: #fff;
        width: 80px;
    }

    .currency-symbol {
        color: #888;
    }

    .total-amount {
        margin-top: 5px;
        padding-top: 15px;
        border-top: 1px solid #1f2330;
        background-color: rgba(51, 133, 255, 0.05);
        border-radius: 0 0 8px 8px;
        padding: 15px;
        margin: 5px -20px -20px -20px;
    }

    .total-amount .detail-value {
        color: #3385ff;
        font-weight: 700;
        font-size: 18px;
    }

    .confirmation-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }

    .cancel-btn, .proceed-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .cancel-btn {
        background-color: #1f2330;
        color: #fff;
        border: 1px solid #2a2d3e;
    }

    .proceed-btn {
        background-color: #3385ff;
        color: #fff;
    }

    .cancel-btn:hover {
        background-color: #252836;
    }

    .proceed-btn:hover {
        background-color: #2a75e8;
    }

    /* Success message styles */
    .success-message {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #4CAF50;
        color: white;
        padding: 15px 20px;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        z-index: 2000;
        animation: fadeInOut 4s ease-in-out;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        max-width: 300px;
        line-height: 1.4;
    }
    
    .success-message i {
        font-size: 18px;
        margin-top: 2px;
    }
    
    .success-message a:hover {
        color: #e0e0e0;
    }
    
    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-20px); }
        15% { opacity: 1; transform: translateY(0); }
        85% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-20px); }
    }

    .edit-button {
        background-color: #3385ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="trades-container">
    <div class="action-buttons">
        <button class="action-btn" onclick="cancelAllOrders()">Cancel all order</button>
        <button class="action-btn" onclick="cancelLimitOrders()">Cancel limit order</button>
        <button class="action-btn" onclick="cancelStopOrders()">Cancel stop order</button>
        <button class="action-btn" onclick="closeAllPositions()">Close all position</button>
        <button class="action-btn" onclick="closeProfitablePositions()">Close profitable position</button>
        <button class="action-btn" onclick="closeLosingPositions()">Close losing position</button>
    </div>

    <div class="account-info">
        <div class="info-item">
            <span>Balance:</span>
            <span id="balance">${{ available_balance|floatformat:2 }}</span>
        </div>
        <div class="info-item">
            <span>Equity:</span>
            <span id="equity">${{ equity|floatformat:2 }}</span>
        </div>
        <div class="info-item">
            <span>Used Margin:</span>
            <span id="usedMargin">0.00</span>
        </div>
        <div class="info-item">
            <span>Free Margin:</span>
            <span id="freeMargin">${{ available_balance|floatformat:2 }}</span>
        </div>
        <div class="info-item">
            <span>Margin Level:</span>
            <span id="marginLevel">0.00 %</span>
        </div>
    </div>

    <table class="trades-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>TIME</th>
                <th>SYMBOL</th>
                <th>ORDER</th>
                <th>LOT</th>
                <th>PRICE</th>
                <th>SL</th>
                <th>TP</th>
                <th>SWAP</th>
                <th>LTP</th>
                <th>PROFIT</th>
                <th>ACTIONS</th>
            </tr>
        </thead>
        <tbody id="tradesBody">
            {% if trades %}
                {% for trade in trades %}
                <tr data-trade-id="{{ trade.id }}">
                    <td>{{ trade.id }}</td>
                    <td>{{ trade.created_at|date:"d M Y" }}<br>{{ trade.created_at|time:"H:i:s" }}</td>
                    <td>{{ trade.symbol }}</td>
                    <td class="trade-type {{ trade.type|lower }}">{{ trade.type }}</td>
                    <td>{{ trade.quantity|floatformat:2 }}</td>
                    <td>{{ trade.entry_price|floatformat:1 }}</td>
                    <td>{% if trade.stop_loss %}{{ trade.stop_loss|floatformat:1 }}{% else %}-{% endif %}</td>
                    <td>{% if trade.take_profit %}{{ trade.take_profit|floatformat:1 }}{% else %}-{% endif %}</td>
                    <td>{% if trade.commission %}{{ trade.commission|floatformat:1 }}{% else %}0.0{% endif %}</td>
                    <td class="ltp">{{ trade.entry_price|floatformat:1 }}</td>
                    <td class="profit">0.0</td>
                    <td>
                        <div class="trade-actions">
                            <button class="action-button edit-button" onclick="showEditSLTPModal('{{ trade.symbol }}', {{ trade.entry_price }}, {{ trade.id }}, {% if trade.stop_loss %}{{ trade.stop_loss }}{% else %}null{% endif %}, {% if trade.take_profit %}{{ trade.take_profit }}{% else %}null{% endif %})">
                                <i class="fas fa-edit"></i><span>Edit</span>
                            </button>
                            <button class="action-button sell-button" onclick="showTradeModal('{{ trade.symbol }}', {{ trade.entry_price }}, 'SELL', {{ trade.id }})">
                                <i class="fas fa-arrow-down"></i><span>Sell</span>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="13" class="no-orders">No Order(s) Found</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Add trade modal -->
<div id="tradeModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Confirm Order</h2>
        <div class="trade-details">
            <div class="detail-row">
                <span class="detail-label">Symbol</span>
                <span class="detail-value" id="modalSymbol">BTC/USDT</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Order Type</span>
                <span class="detail-value" id="modalOrderType">BUY</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Quantity</span>
                <div class="quantity-wrapper">
                    <input type="number" id="modalQuantity" class="quantity-input" min="0.01" step="0.01" value="0.10">
                    <span class="currency-symbol" id="modalCurrencySymbol">BTC</span>
                </div>
            </div>
            <div class="detail-row">
                <span class="detail-label">Price</span>
                <span class="detail-value" id="modalPrice">0.00</span>
            </div>
            <div class="detail-row total-amount">
                <span class="detail-label">Total Amount</span>
                <span class="detail-value" id="modalTotal">0.00</span>
            </div>
        </div>
        <div class="confirmation-buttons">
            <button class="cancel-btn" onclick="closeTradeModal()">Cancel</button>
            <button class="proceed-btn" onclick="submitOrder()">Confirm Order</button>
        </div>
    </div>
</div>

<!-- Add SL/TP edit modal -->
<div id="sltpModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Edit Stop Loss & Take Profit</h2>
        <div class="trade-details">
            <div class="detail-row">
                <span class="detail-label">Symbol</span>
                <span class="detail-value" id="sltpModalSymbol">BTC/USDT</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Current Price</span>
                <span class="detail-value" id="sltpModalPrice">0.00</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Stop Loss</span>
                <div class="quantity-wrapper">
                    <input type="number" id="modalStopLoss" class="quantity-input" step="0.01" placeholder="Set stop loss">
                </div>
            </div>
            <div class="detail-row">
                <span class="detail-label">Take Profit</span>
                <div class="quantity-wrapper">
                    <input type="number" id="modalTakeProfit" class="quantity-input" step="0.01" placeholder="Set take profit">
                </div>
            </div>
        </div>
        <div class="confirmation-buttons">
            <button class="cancel-btn" onclick="closeSLTPModal()">Cancel</button>
            <button class="proceed-btn" onclick="updateSLTP()">Update</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Optimized WebSocket connection for real-time price updates with minimal delay
    const ws = new WebSocket('wss://stream.binance.com:9443/ws');
    
    // Cache DOM elements to reduce DOM queries
    const tradeRows = new Map();
    
    // Set up price stream with optimized parameters
    const subscribeToPriceStreams = () => {
        // Cache all trade rows and organize by symbol for faster lookups
        document.querySelectorAll('#tradesBody tr').forEach(tr => {
            const tradeId = tr.dataset.tradeId;
            if (!tradeId) return;
            
            const symbolElement = tr.querySelector('td:nth-child(3)');
            if (!symbolElement) return;
            
            const symbol = symbolElement.textContent;
            
            // Get SL and TP values
            const slElement = tr.querySelector('td:nth-child(8)');
            const tpElement = tr.querySelector('td:nth-child(9)');
            
            const sl = slElement.textContent !== '-' ? parseFloat(slElement.textContent) : null;
            const tp = tpElement.textContent !== '-' ? parseFloat(tpElement.textContent) : null;
            
            // Cache DOM elements and values for this trade
            tradeRows.set(tradeId, {
                row: tr,
                symbol: symbol,
                ltpElement: tr.querySelector('.ltp'),
                profitElement: tr.querySelector('.profit'),
                entryPrice: parseFloat(tr.querySelector('td:nth-child(6)').textContent),
                quantity: parseFloat(tr.querySelector('td:nth-child(5)').textContent),
                type: tr.querySelector('td:nth-child(4)').textContent.toLowerCase(),
                sl: sl,
                tp: tp,
                actions: tr.querySelector('.trade-actions'),
                tradeId: tradeId
            });
            
            // Create a map of symbols to trade IDs for fast lookup
            if (!window.symbolToTrades) window.symbolToTrades = {};
            if (!window.symbolToTrades[symbol]) window.symbolToTrades[symbol] = [];
            window.symbolToTrades[symbol].push(tradeId);
        });
        
        // Get unique symbols
        const symbols = [...new Set(Array.from(tradeRows.values()).map(trade => trade.symbol))];
        const streamParams = symbols.map(symbol => `${symbol.toLowerCase()}@trade`);
        
        if (streamParams.length > 0) {
            // Use binary form of WebSocket for better performance
            ws.binaryType = "arraybuffer";
            
            // Subscribe to all price feeds in a single message
            ws.send(JSON.stringify({
                method: "SUBSCRIBE",
                params: streamParams,
                id: 1
            }));
            
            // Set high priority for WebSocket connection
            if (navigator.scheduling && navigator.scheduling.isInputPending) {
                // Use the prioritized tasks API if available (Chrome)
                window.prioritizedUpdates = true;
            }
        }
    };

    ws.onopen = () => {
        console.log('WebSocket Connected');
        subscribeToPriceStreams();
    };

    // Optimized message handler with debouncing
    let lastUpdateTime = {};
    const UPDATE_THROTTLE = 50; // ms - minimum time between updates for the same symbol
    
    // Track trades pending close to avoid duplicate close requests
    const pendingCloses = new Set();
    
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.e === 'trade') {
            const symbol = data.s;
            const price = parseFloat(data.p);
            const now = performance.now();
            
            // Throttle updates for the same symbol
            if (lastUpdateTime[symbol] && (now - lastUpdateTime[symbol] < UPDATE_THROTTLE)) {
                return;
            }
            
            lastUpdateTime[symbol] = now;
            
            // Use the optimized lookup
            const tradeIds = window.symbolToTrades?.[symbol] || [];
            
            // Use requestAnimationFrame for visual updates to sync with screen refresh
            requestAnimationFrame(() => {
                tradeIds.forEach(tradeId => {
                    const trade = tradeRows.get(tradeId);
                    if (!trade) return;
                    
                    // Update LTP
                    trade.ltpElement.textContent = price.toFixed(1);
                    
                    // Calculate and update profit
                    let profit = 0;
                    if (trade.type === 'buy') {
                        profit = (price - trade.entryPrice) * trade.quantity;
                    } else {
                        profit = (trade.entryPrice - price) * trade.quantity;
                    }
                    
                    trade.profitElement.textContent = profit.toFixed(1);
                    trade.profitElement.className = `profit ${profit >= 0 ? 'positive' : 'negative'}`;
                    
                    // Check for SL/TP hit
                    let slTpHit = false;
                    let hitType = '';
                    
                    // Avoid checking trades already being closed
                    if (pendingCloses.has(tradeId)) return;
                    
                    if (trade.type === 'buy') {
                        // For Buy trades: price <= SL is a stop loss hit
                        if (trade.sl && price <= trade.sl) {
                            slTpHit = true;
                            hitType = 'Stop Loss';
                        }
                        // For Buy trades: price >= TP is a take profit hit
                        else if (trade.tp && price >= trade.tp) {
                            slTpHit = true;
                            hitType = 'Take Profit';
                        }
                    } else { // Sell trade
                        // For Sell trades: price >= SL is a stop loss hit
                        if (trade.sl && price >= trade.sl) {
                            slTpHit = true;
                            hitType = 'Stop Loss';
                        }
                        // For Sell trades: price <= TP is a take profit hit
                        else if (trade.tp && price <= trade.tp) {
                            slTpHit = true;
                            hitType = 'Take Profit';
                        }
                    }
                    
                    // If SL/TP hit, close the trade automatically
                    if (slTpHit) {
                        console.log(`${hitType} hit for trade ${tradeId} at price ${price}`);
                        
                        // Mark this trade as pending close to avoid duplicate requests
                        pendingCloses.add(tradeId);
                        
                        // Show indicator that the trade is being closed
                        trade.row.style.backgroundColor = hitType === 'Stop Loss' ? 'rgba(244, 67, 54, 0.2)' : 'rgba(76, 175, 80, 0.2)';
                        
                        // Disable action buttons during close
                        if (trade.actions) {
                            const buttons = trade.actions.querySelectorAll('button');
                            buttons.forEach(btn => {
                                btn.disabled = true;
                                btn.style.opacity = '0.5';
                            });
                        }
                        
                        // Close the trade via API
                        closeTradeAutomatically(trade.tradeId, price, hitType);
                    }
                });
            });
        }
    };
    
    // Function to automatically close a trade when SL/TP is hit
    async function closeTradeAutomatically(tradeId, closingPrice, hitType) {
        try {
            console.log(`Automatically closing trade ${tradeId} at ${closingPrice} due to ${hitType}`);
            
            const response = await fetch('/api/close_trade/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    trade_id: tradeId,
                    closing_price: closingPrice
                })
            });
            
            const data = await response.json();
            console.log('Close trade response:', data);
            
            if (data.success) {
                const trade = tradeRows.get(tradeId);
                if (trade) {
                    // Show success message with hit type
                    showSuccessMessage(`${trade.symbol} closed automatically - ${hitType} triggered at ${closingPrice.toFixed(1)}`);
                    
                    // This trade is now closed and will appear in the history page
                    
                    // Animate row fadeout
                    trade.row.style.transition = "opacity 0.5s, transform 0.5s";
                    trade.row.style.opacity = "0";
                    trade.row.style.transform = "translateY(-10px)";
                    
                    // Remove after animation
                    setTimeout(() => {
                        trade.row.remove();
                        
                        // Check if there are any trades left
                        const remainingTrades = document.querySelectorAll('#tradesBody tr:not(.no-orders)');
                        if (remainingTrades.length === 0) {
                            // Add the "No orders found" row
                            const noOrdersRow = document.createElement('tr');
                            noOrdersRow.innerHTML = '<td colspan="13" class="no-orders">No Order(s) Found</td>';
                            document.getElementById('tradesBody').appendChild(noOrdersRow);
                        }
                    }, 500);
                }
            } else {
                // Log error and remove from pending closes to allow retry
                console.error('Failed to close trade:', data.error || data.message);
                pendingCloses.delete(tradeId);
                
                // Return the row to normal state
                const trade = tradeRows.get(tradeId);
                if (trade) {
                    trade.row.style.backgroundColor = '';
                    if (trade.actions) {
                        const buttons = trade.actions.querySelectorAll('button');
                        buttons.forEach(btn => {
                            btn.disabled = false;
                            btn.style.opacity = '1';
                        });
                    }
                }
            }
        } catch (error) {
            console.error('Error closing trade automatically:', error);
            pendingCloses.delete(tradeId);
            
            // Return the row to normal state
            const trade = tradeRows.get(tradeId);
            if (trade) {
                trade.row.style.backgroundColor = '';
                if (trade.actions) {
                    const buttons = trade.actions.querySelectorAll('button');
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                }
            }
        }
    }

    // Add connection reliability
    ws.onclose = () => {
        console.log("WebSocket closed, reconnecting...");
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    };

    ws.onerror = (error) => {
        console.error("WebSocket error:", error);
        // Try to reconnect on error
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    };

    // Action button functions
    async function cancelAllOrders() {
        try {
            const response = await fetch('/api/cancel_all_orders/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to cancel orders: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to cancel orders');
        }
    }

    async function cancelLimitOrders() {
        try {
            const response = await fetch('/api/cancel_limit_orders/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to cancel limit orders: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to cancel limit orders');
        }
    }

    async function cancelStopOrders() {
        try {
            const response = await fetch('/api/cancel_stop_orders/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to cancel stop orders: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to cancel stop orders');
        }
    }

    async function closeAllPositions() {
        try {
            const response = await fetch('/api/close_all_positions/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to close positions: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to close positions');
        }
    }

    async function closeProfitablePositions() {
        try {
            const response = await fetch('/api/close_profitable_positions/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to close profitable positions: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to close profitable positions');
        }
    }

    async function closeLosingPositions() {
        try {
            const response = await fetch('/api/close_losing_positions/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to close losing positions: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to close losing positions');
        }
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Trade modal functions
    function showTradeModal(symbol, price, orderType, tradeId) {
        const modal = document.getElementById('tradeModal');
        const modalSymbol = document.getElementById('modalSymbol');
        const modalOrderType = document.getElementById('modalOrderType');
        const modalPrice = document.getElementById('modalPrice');
        const modalQuantity = document.getElementById('modalQuantity');
        const modalCurrencySymbol = document.getElementById('modalCurrencySymbol');
        const modalTotal = document.getElementById('modalTotal');
        
        // Store trade ID in modal for later use
        modal.dataset.tradeId = tradeId;

        // Set modal values
        modalSymbol.textContent = symbol;
        modalOrderType.textContent = orderType;
        modalOrderType.style.color = orderType === 'BUY' ? '#4CAF50' : '#f44336';

        // Get quantity from the trade data dynamically
        const tradeRow = document.querySelector(`tr[data-trade-id="${tradeId}"]`);
        let displayPrice = price;
        if (tradeRow) {
            const tradeQuantity = parseFloat(tradeRow.querySelector('td:nth-child(5)').textContent);
            modalQuantity.value = tradeQuantity.toFixed(2);
            if (orderType === 'SELL') {
                // Use LTP value for sell
                const ltpCell = tradeRow.querySelector('.ltp');
                if (ltpCell && !isNaN(parseFloat(ltpCell.textContent))) {
                    displayPrice = parseFloat(ltpCell.textContent);
                }
            }
        } else {
            // Default quantity if trade row not found
            modalQuantity.value = "0.10";
        }

        // Set price in modal
        modalPrice.textContent = displayPrice.toFixed(1);
        
        // Set currency symbol (first part of the trading pair)
        const currencySymbol = symbol.split('/')[0] || symbol.substring(0, 3);
        modalCurrencySymbol.textContent = currencySymbol;

        // Calculate total
        calculateTotal();

        // Add event listener for quantity changes
        modalQuantity.addEventListener('input', calculateTotal);

        // Center and display modal
        document.body.style.overflow = 'hidden'; // Prevent scrolling of background
        modal.style.display = 'block';

        function calculateTotal() {
            const quantity = parseFloat(modalQuantity.value) || 0;
            const total = quantity * displayPrice;
            modalTotal.textContent = total.toFixed(2); // Display 2 decimal places for total
        }
    }

    function closeTradeModal() {
        const modal = document.getElementById('tradeModal');
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
    }

    async function submitOrder() {
        const modal = document.getElementById('tradeModal');
        const symbol = document.getElementById('modalSymbol').textContent;
        const orderType = document.getElementById('modalOrderType').textContent;
        const price = parseFloat(document.getElementById('modalPrice').textContent);
        const quantity = parseFloat(document.getElementById('modalQuantity').value).toFixed(2);
        const tradeId = modal.dataset.tradeId;

        try {
            // Log the request for debugging
            console.log('Sending close trade request:', {
                trade_id: tradeId,
                closing_price: price
            });

            // We're selling/closing an existing trade, so use a different endpoint
            const response = await fetch('/api/close_trade/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    trade_id: tradeId,
                    closing_price: price
                })
            });
            
            // Log the response status
            console.log('Response status:', response.status);
            
            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.success) {
                // Close the modal first
                closeTradeModal();
                
                // Show success message
                showSuccessMessage(`${symbol} sold successfully at ${price.toFixed(1)}`);
                
                // This trade is now closed and will appear in the history page
                
                // Remove the trade row if it was successfully sold
                const tradeRow = document.querySelector(`tr[data-trade-id="${tradeId}"]`);
                if (tradeRow) {
                    // Animate fadeout
                    tradeRow.style.transition = "opacity 0.5s, transform 0.5s";
                    tradeRow.style.opacity = "0";
                    tradeRow.style.transform = "translateY(-10px)";
                    
                    // Remove after animation
                    setTimeout(() => {
                        tradeRow.remove();
                        
                        // Check if there are any trades left
                        const remainingTrades = document.querySelectorAll('#tradesBody tr:not(.no-orders)');
                        if (remainingTrades.length === 0) {
                            // Add the "No orders found" row
                            const noOrdersRow = document.createElement('tr');
                            noOrdersRow.innerHTML = '<td colspan="13" class="no-orders">No Order(s) Found</td>';
                            document.getElementById('tradesBody').appendChild(noOrdersRow);
                        }
                    }, 500);
                }
            } else {
                // Show detailed error message
                let errorMessage = 'Failed to close trade';
                if (data.error) {
                    errorMessage += ': ' + data.error;
                } else if (data.message) {
                    errorMessage += ': ' + data.message;
                }
                alert(errorMessage);
            }
        } catch (error) {
            console.error('Error closing trade:', error);
            alert('Failed to close trade. Please check the console for details.');
        }
    }

    // Function to show success message
    function showSuccessMessage(message) {
        // Create success message element
        const successMessage = document.createElement('div');
        successMessage.className = 'success-message';
        
        // Check if this is a trade closing message
        if (message.includes('closed automatically') || message.includes('sold successfully')) {
            // Add a link to the history page
            successMessage.innerHTML = `
                <i class="fas fa-check-circle"></i> 
                ${message}<br>
                <span style="font-size: 12px; margin-top: 5px; display: block;">
                    Trade added to <a href="/history/" style="color: white; text-decoration: underline;">trade history</a>
                </span>
            `;
        } else {
            successMessage.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        }
        
        // Add to document
        document.body.appendChild(successMessage);
        
        // Remove after animation completes
        setTimeout(() => {
            successMessage.remove();
        }, 4000); // Match the animation duration
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('tradeModal');
        const sltpModal = document.getElementById('sltpModal');
        if (event.target === modal) {
            closeTradeModal();
        } else if (event.target === sltpModal) {
            closeSLTPModal();
        }
    }

    // Close modals when clicking the close buttons
    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal.id === 'tradeModal') {
                closeTradeModal();
            } else if (modal.id === 'sltpModal') {
                closeSLTPModal();
            }
        });
    });

    // SLTP modal functions
    function showEditSLTPModal(symbol, price, tradeId, stopLoss, takeProfit) {
        const modal = document.getElementById('sltpModal');
        const modalSymbol = document.getElementById('sltpModalSymbol');
        const modalPrice = document.getElementById('sltpModalPrice');
        const modalStopLoss = document.getElementById('modalStopLoss');
        const modalTakeProfit = document.getElementById('modalTakeProfit');
        
        // Store trade ID in modal for later use
        modal.dataset.tradeId = tradeId;

        // Set modal values
        modalSymbol.textContent = symbol;
        modalPrice.textContent = price.toFixed(1);
        
        // Set existing SL/TP values if they exist
        if (stopLoss !== null) {
            modalStopLoss.value = stopLoss;
        } else {
            modalStopLoss.value = '';
        }
        
        if (takeProfit !== null) {
            modalTakeProfit.value = takeProfit;
        } else {
            modalTakeProfit.value = '';
        }

        // Display modal
        document.body.style.overflow = 'hidden'; // Prevent scrolling of background
        modal.style.display = 'block';
    }

    function closeSLTPModal() {
        const modal = document.getElementById('sltpModal');
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
    }

    async function updateSLTP() {
        const modal = document.getElementById('sltpModal');
        const tradeId = modal.dataset.tradeId;
        const stopLoss = document.getElementById('modalStopLoss').value;
        const takeProfit = document.getElementById('modalTakeProfit').value;

        try {
            // Log the request for debugging
            console.log('Sending update SLTP request:', {
                trade_id: tradeId,
                stop_loss: stopLoss || null,
                take_profit: takeProfit || null
            });

            // Update the SL/TP values
            const response = await fetch('/api/update_sltp/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    trade_id: tradeId,
                    stop_loss: stopLoss || null,
                    take_profit: takeProfit || null
                })
            });
            
            // Log the response status
            console.log('Response status:', response.status);
            
            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.success) {
                // Close the modal first
                closeSLTPModal();
                
                // Show success message
                showSuccessMessage('Stop Loss and Take Profit updated successfully');
                
                // Update the values in the table
                const tradeRow = document.querySelector(`tr[data-trade-id="${tradeId}"]`);
                if (tradeRow) {
                    // Update SL cell
                    const slCell = tradeRow.querySelector('td:nth-child(8)'); // 8th column is SL
                    slCell.textContent = stopLoss ? parseFloat(stopLoss).toFixed(1) : '-';
                    
                    // Update TP cell
                    const tpCell = tradeRow.querySelector('td:nth-child(9)'); // 9th column is TP
                    tpCell.textContent = takeProfit ? parseFloat(takeProfit).toFixed(1) : '-';
                }
            } else {
                // Show detailed error message
                let errorMessage = 'Failed to update Stop Loss and Take Profit';
                if (data.error) {
                    errorMessage += ': ' + data.error;
                } else if (data.message) {
                    errorMessage += ': ' + data.message;
                }
                alert(errorMessage);
            }
        } catch (error) {
            console.error('Error updating SLTP:', error);
            alert('Failed to update Stop Loss and Take Profit. Please check the console for details.');
        }
    }
</script>
{% endblock %}


