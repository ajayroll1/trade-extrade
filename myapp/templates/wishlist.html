{% extends 'base.html' %}

{% block title %}Wishlist - Trading Platform{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #2a2d3e;
        --secondary-color: #1f2130;
        --accent-color: #00c7ff;
        --text-color: #ffffff;
        --positive-color: #4CAF50;
        --negative-color: #f44336;
        --bg-color: #000000;
        --card-bg: #1a1a1a;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    .trading-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background: var(--card-bg);
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .top-pairs {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .pair-box {
        background: var(--card-bg);
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        min-width: 200px;
        flex: 1;
        color: var(--text-color);
    }

    .pair-box span {
        display: block;
    }

    .pair-box .price {
        font-size: 1.4em;
        font-weight: bold;
        margin: 8px 0;
        color: var(--text-color);
    }

    .pair-box .change {
        font-size: 0.9em;
        font-weight: 500;
    }

    .change.positive {
        color: #00c853;
    }

    .change.negative {
        color: #ff3d00;
    }

    .search-bar {
        position: relative;
        margin-bottom: 20px;
    }

    .search-bar input {
        width: 100%;
        padding: 12px 40px 12px 15px;
        border: 1px solid #333;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
        background: var(--card-bg);
        color: var(--text-color);
    }

    .search-bar input:focus {
        border-color: var(--accent-color);
        outline: none;
    }

    .search-bar i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
    }

    .tabs {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .tab {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 500;
        color: #666;
        transition: all 0.3s;
    }

    .tab.active {
        color: var(--accent-color);
        border-bottom: 2px solid var(--accent-color);
    }

    .pairs-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .pair-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-radius: 8px;
        background: var(--card-bg);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: transform 0.2s;
        position: relative;
        color: var(--text-color);
    }

    .pair-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .symbol {
        font-weight: bold;
        font-size: 1.1em;
        min-width: 100px;
    }

    .values {
        text-align: right;
    }

    .main-value {
        font-weight: bold;
        font-size: 1.1em;
    }

    .change {
        font-size: 0.9em;
        margin-top: 5px;
    }

    .change.positive {
        color: var(--positive-color);
    }

    .change.negative {
        color: var(--negative-color);
    }

    .hl-values {
        display: flex;
        gap: 20px;
        color: #666;
        font-size: 0.9em;
    }

    .pair-actions {
        display: none;
        gap: 10px;
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
    }

    .pair-item:hover .pair-actions {
        display: flex;
    }

    .action-button {
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .buy-button {
        background: var(--positive-color);
    }

    .sell-button {
        background: var(--negative-color);
    }

    .delete-button {
        background: #666;
    }

    .action-button:hover {
        opacity: 0.9;
        transform: scale(1.05);
    }

    .market-categories {
        background: #1a1d26;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 20px;
        display: none; /* Hidden by default */
    }

    .market-category {
        border-bottom: 1px solid #2a2d3e;
    }

    .market-category:last-child {
        border-bottom: none;
    }

    .category-header {
        padding: 15px 20px;
        background: #1a1d26;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #fff;
        transition: background-color 0.2s;
    }

    .category-header:hover {
        background: #22252f;
    }

    .category-header i {
        color: #666;
        transition: transform 0.3s;
    }

    .category-header.active i {
        transform: rotate(180deg);
    }

    .category-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background: #12151c;
    }

    .category-content.active {
        max-height: 400px;
        overflow-y: auto;
    }

    /* Custom scrollbar for category content */
    .category-content::-webkit-scrollbar {
        width: 6px;
    }

    .category-content::-webkit-scrollbar-track {
        background: #0a0c12;
    }

    .category-content::-webkit-scrollbar-thumb {
        background: #2a2d3e;
        border-radius: 3px;
    }

    .category-content::-webkit-scrollbar-thumb:hover {
        background: #3385ff;
    }

    .symbol-item {
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        transition: all 0.2s;
        color: #666;
        border-bottom: 1px solid #1a1d26;
    }

    .symbol-item:hover {
        background: #1f2330;
        color: #fff;
    }

    .symbol-item span:first-child {
        font-weight: 500;
        width: 40%;
        flex-shrink: 0;
    }

    .symbol-item span:nth-child(2) {
        color: #3385ff;
        text-align: right;
        width: 40%;
        padding-right: 150px; /* Increase padding to make room for the button */
    }

    .symbol-item .add-to-wishlist {
        position: absolute;
        right: 120px; /* Moving it more to the left by changing from 20px to 120px */
        display: none;
        background: #3385ff;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
        z-index: 1;
    }

    .symbol-item:hover .add-to-wishlist {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .symbol-item .add-to-wishlist:hover {
        background: #2970d9;
        transform: translateY(-1px);
    }

    /* Category-specific colors */
    .market-category[data-category="Crypto"] .symbol-item span:last-child {
        color: #f7931a;
    }

    .market-category[data-category="Stocks"] .symbol-item span:last-child {
        color: #00c853;
    }

    .market-category[data-category="Indices"] .symbol-item span:last-child {
        color: #ff9800;
    }

    .market-category[data-category="Commodities"] .symbol-item span:last-child {
        color: #ffd700;
    }

    .market-category[data-category="Forex"] .symbol-item span:last-child {
        color: #e91e63;
    }

    .pairs-list.hidden {
        display: none;
    }

    .tab.active {
        color: #3385ff;
        border-bottom: 2px solid #3385ff;
    }

    /* Ensure proper display states */
    .market-categories {
        display: none;
    }

    .pairs-list {
        display: flex;
        flex-direction: column;
    }

    @media (max-width: 768px) {
        .pair-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .pair-actions {
            position: static;
            transform: none;
            margin-top: 10px;
            display: flex;
        }

        .hl-values {
            width: 100%;
            justify-content: space-between;
        }

        .modal-content {
            width: 90%;
            margin: 30% auto;
            padding: 15px;
        }

        .buttons, .confirmation-buttons {
            flex-direction: column;
            grid-template-columns: 1fr;
        }

        .quantity-wrapper {
            flex-direction: column;
            align-items: flex-start;
        }

        .currency-symbol {
            margin-top: -10px;
            margin-bottom: 5px;
        }

        .symbol-item span:nth-child(2) {
            padding-right: 80px; /* Less padding on mobile */
        }

        .symbol-item .add-to-wishlist {
            right: 10px; /* Move button closer to the right on mobile */
        }
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
    }

    .modal-content {
        background-color: #1a1d26;
        margin: 15% auto;
        padding: 20px;
        width: 360px;
        border-radius: 16px;
        position: relative;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
        border: 1px solid #2a2d3e;
        animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .close {
        position: absolute;
        right: 20px;
        top: 20px;
        color: #666;
        font-size: 20px;
        font-weight: 500;
        cursor: pointer;
        transition: color 0.2s;
    }

    .close:hover {
        color: #fff;
    }

    .modal h2 {
        color: #fff;
        font-size: 20px;
        margin: 0 0 20px 0;
        font-weight: 500;
    }

    .current-price {
        background-color: #12151c;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #999;
    }

    .current-price #modalPrice {
        color: #3385ff;
        font-size: 18px;
        font-weight: 600;
    }

    .trade-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-group label {
        color: #999;
        font-size: 14px;
    }

    .form-group input {
        background: #1f2330;
        border: 1px solid #2a2d3e;
        border-radius: 8px;
        padding: 12px 15px;
        color: #fff;
        font-size: 15px;
        transition: border-color 0.2s;
    }

    .form-group input:focus {
        outline: none;
        border-color: #3385ff;
    }

    .buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 10px;
    }

    .buy-btn, .sell-btn {
        padding: 12px 0;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .buy-btn {
        background: var(--positive-color);
        color: white;
    }

    .sell-btn {
        background: var(--negative-color);
        color: white;
    }

    .buy-btn:hover {
        background: #3da142;
        transform: translateY(-2px);
    }

    .sell-btn:hover {
        background: #e03b2e;
        transform: translateY(-2px);
    }

    .trade-details {
        background-color: #12151c;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        border: 1px solid #1f2330;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #1f2330;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        color: #888;
        font-size: 14px;
    }

    .detail-value {
        color: #fff;
        font-size: 15px;
        font-weight: 500;
    }

    .total-amount {
        margin-top: 5px;
        padding-top: 15px;
        border-top: 1px solid #1f2330;
        background-color: rgba(51, 133, 255, 0.05);
        border-radius: 0 0 8px 8px;
        padding: 15px;
        margin: 5px -20px -20px -20px;
    }

    .total-amount .detail-label {
        color: #999;
        font-weight: 500;
    }

    .total-amount .detail-value {
        color: #3385ff;
        font-weight: 700;
        font-size: 18px;
    }

    .confirmation-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }

    .cancel-btn, .proceed-btn {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .cancel-btn {
        background-color: #1f2330;
        color: #fff;
        border: 1px solid #2a2d3e;
    }

    .proceed-btn {
        background-color: #3385ff;
        color: #fff;
    }

    .cancel-btn:hover {
        background-color: #252836;
        transform: translateY(-2px);
    }

    .proceed-btn:hover {
        background-color: #2970d9;
        transform: translateY(-2px);
    }

    .quantity-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #1f2330;
        border-radius: 8px;
        padding: 0 10px;
        border: 1px solid #2a2d3e;
    }

    .quantity-input {
        background: transparent;
        border: none;
        color: #fff;
        padding: 12px 5px;
        width: 100%;
        font-size: 15px;
    }

    .quantity-input:focus {
        outline: none;
    }

    .currency-symbol {
        color: #888;
        font-size: 14px;
        font-weight: 500;
    }

    /* Remove number input arrows */
    .quantity-input::-webkit-outer-spin-button,
    .quantity-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .quantity-input[type=number] {
        -moz-appearance: textfield;
    }

    .toast-message {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 24px;
        border-radius: 4px;
        z-index: 1000;
        animation: slideIn 0.3s, fadeOut 0.3s 2.7s;
    }

    .toast-message.success {
        background: #4CAF50;
        color: white;
    }

    .toast-message.error {
        background: #f44336;
        color: white;
    }

    @keyframes slideIn {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }

    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }

    .add-to-wishlist {
        position: absolute;
        right: 20px;
        display: none;
        background: #3385ff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
        z-index: 1;
    }

    .symbol-item:hover .add-to-wishlist {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .add-to-wishlist:hover {
        background: #2970d9;
        transform: translateY(-1px);
    }

    /* Loading indicator styles */
    .loading-indicator::before {
        content: "";
        width: 20px;
        height: 20px;
        border: 2px solid #3385ff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Loading placeholder styles */
    .loading-placeholder {
        padding: 20px;
        text-align: center;
        color: #666;
        cursor: pointer;
        transition: all 0.2s;
    }

    .loading-placeholder:hover {
        background: #1f2130;
        color: #fff;
    }

    /* Styles for error message */
    .error-message {
        padding: 15px;
        color: #ff3d00;
        text-align: center;
    }

    /* Empty state styles */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        background: #1a1d26;
        border-radius: 12px;
        margin: 20px 0;
    }

    /* Price change animation */
    @keyframes priceChange {
        0% { background-color: transparent; }
        20% { background-color: rgba(52, 152, 219, 0.2); }
        100% { background-color: transparent; }
    }

    @keyframes priceUp {
        0% { background-color: transparent; }
        20% { background-color: rgba(46, 204, 113, 0.2); }
        100% { background-color: transparent; }
    }

    @keyframes priceDown {
        0% { background-color: transparent; }
        20% { background-color: rgba(231, 76, 60, 0.2); }
        100% { background-color: transparent; }
    }

    .price-changed {
        animation: priceChange 1.5s ease-out;
    }

    .price-up {
        animation: priceUp 1.5s ease-out;
    }

    .price-down {
        animation: priceDown 1.5s ease-out;
    }

    /* Add CSS for the new crypto search */
    .crypto-search {
        margin-bottom: 15px;
        padding: 0 10px;
    }

    .crypto-search-input {
        width: 100%;
        padding: 10px 15px;
        background: #1f2330;
        border: 1px solid #2a2d3e;
        border-radius: 6px;
        color: #fff;
        font-size: 14px;
    }

    .crypto-search-input:focus {
        outline: none;
        border-color: #3385ff;
    }

    .crypto-list {
        max-height: 350px;
        overflow-y: auto;
    }

    .crypto-list::-webkit-scrollbar {
        width: 6px;
    }

    .crypto-list::-webkit-scrollbar-track {
        background: #0a0c12;
    }

    .crypto-list::-webkit-scrollbar-thumb {
        background: #2a2d3e;
        border-radius: 3px;
    }

    .crypto-list::-webkit-scrollbar-thumb:hover {
        background: #3385ff;
    }

    /* Add CSS for the change indicators */
    .symbol-change {
        font-size: 0.85em;
        margin-right: 10px;
        width: 60px;
        text-align: right;
    }

    .symbol-change.positive {
        color: var(--positive-color);
    }

    .symbol-change.negative {
        color: var(--negative-color);
    }

    /* Success message styles */
    .success-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }

    .success-overlay.visible {
        opacity: 1;
        visibility: visible;
    }

    .success-popup {
        background-color: #1a1d26;
        padding: 25px;
        border-radius: 12px;
        width: 360px;
        max-width: 90%;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        transform: translateY(30px);
        transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        text-align: center;
    }

    .success-overlay.visible .success-popup {
        transform: translateY(0);
    }

    .success-icon {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        margin: 0 auto 15px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 30px;
    }

    .success-popup h3 {
        margin: 0 0 20px;
        color: #fff;
        font-size: 18px;
        font-weight: 500;
    }

    .success-details {
        background-color: #12151c;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: left;
    }

    .success-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #1f2330;
    }

    .success-row:last-child {
        border-bottom: none;
    }

    .success-row.total {
        margin-top: 5px;
        padding-top: 10px;
        border-top: 1px solid #1f2330;
        font-weight: bold;
    }

    .success-row span:first-child {
        color: #888;
    }

    .success-row span:last-child {
        color: #fff;
        font-weight: 500;
    }

    .close-success {
        background-color: #3385ff;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 12px 0;
        font-size: 14px;
        font-weight: 500;
        width: 100%;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.2s;
    }

    .close-success:hover {
        background-color: #2970d9;
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="trading-container">
    <div class="top-pairs">
        <a href="/analytics/?symbol=EURUSDT" class="pair-box-link">
            <div class="pair-box" id="EURUSDT">
                <span class="pair-name">EUR/USDT</span>
                <span class="price">$ 1.13</span>
                <span class="change negative">-0.21%</span>
            </div>
        </a>
        <a href="/analytics/?symbol=BTCUSDT" class="pair-box-link">
            <div class="pair-box" id="BTCUSDT">
                <span class="pair-name">BTC/USDT</span>
                <span class="price">$ 93,320.48</span>
                <span class="change positive">+0.87%</span>
            </div>
        </a>
        <a href="/analytics/?symbol=ETHUSDT" class="pair-box-link">
            <div class="pair-box" id="ETHUSDT">
                <span class="pair-name">ETH/USDT</span>
                <span class="price">$ 1,770.13</span>
                <span class="change positive">+0.01%</span>
            </div>
        </a>
    </div>

    <!-- Add code to load wishlist items from database -->
    <script>
        // Function to setup WebSocket for crypto pair price updates
        function setupWebSocket(symbol, element) {
            console.log("Setting up WebSocket for:", symbol);
            if (!symbol.includes('USDT')) return;

            try {
                const socket = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}@ticker`);
                let lastPrice = null;

                socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    const priceElement = element.querySelector('.main-value');
                    const changeElement = element.querySelector('.change');

                    if (priceElement && changeElement) {
                        const price = parseFloat(data.c);
                        const priceChange = parseFloat(data.P); // 24h price change percent

                        // Format price based on value
                        const formattedPrice = price < 0.01 ? price.toFixed(8) :
                                             price < 1 ? price.toFixed(5) :
                                             price < 100 ? price.toFixed(3) :
                                             price.toFixed(2);

                        // Update price with animation
                        priceElement.textContent = formattedPrice;

                        // Remove any existing animation classes
                        priceElement.classList.remove('price-up', 'price-down', 'price-changed');

                        // Add animation based on price change direction
                        if (lastPrice !== null) {
                            if (price > lastPrice) {
                                priceElement.classList.add('price-up');
                            } else if (price < lastPrice) {
                                priceElement.classList.add('price-down');
                            } else {
                                priceElement.classList.add('price-changed');
                            }
                        }

                        // Update change display
                        changeElement.textContent = `${priceChange.toFixed(2)}% ${priceChange >= 0 ? '↑' : '↓'}`;
                        changeElement.className = `change ${priceChange >= 0 ? 'positive' : 'negative'}`;

                        // Store current price for next comparison
                        lastPrice = price;
                    }
                };

                socket.onerror = (error) => {
                    console.error(`WebSocket Error for ${symbol}:`, error);
                };

                socket.onclose = () => {
                    console.log(`WebSocket Closed for ${symbol}`);
                    // Attempt to reconnect after 5 seconds
                    setTimeout(() => setupWebSocket(symbol, element), 5000);
                };
            } catch (error) {
                console.error('WebSocket setup error:', error);
            }
        }

        // Function to simulate live price updates for non-crypto items
        function setupSimulatedLiveUpdates(element, basePrice, category) {
            console.log("Setting up simulated updates for:", element.getAttribute('data-symbol'), "Category:", category);
            // Store initial price for reference
            element.setAttribute('data-base-price', basePrice);

            // Set volatility based on category
            let volatility;
            switch(category) {
                case 'Stocks': volatility = 0.002; break;     // 0.2% per update
                case 'Indices': volatility = 0.0008; break;   // 0.08% per update
                case 'Commodities': volatility = 0.0015; break; // 0.15% per update
                case 'Forex': volatility = 0.0005; break;     // 0.05% per update
                default: volatility = 0.001;
            }

            // Setup interval for updates (random between 5-12 seconds)
            const updateInterval = Math.floor(Math.random() * 7000) + 5000;

            // Store total change for tracking daily change
            let totalChange = 0;
            let lastPrice = basePrice;

            // Create update function
            const updateFn = () => {
                const priceElement = element.querySelector('.main-value');
                const changeElement = element.querySelector('.change');

                if (!priceElement || !changeElement) return;

                // Generate random price change with specified volatility
                const changePercent = (Math.random() * 2 - 1) * volatility;
                totalChange += changePercent;

                // Calculate new price
                const currentPrice = parseFloat(priceElement.textContent);
                const newPrice = currentPrice * (1 + changePercent);

                // Format based on value
                const formattedPrice = newPrice < 0.01 ? newPrice.toFixed(8) :
                                     newPrice < 1 ? newPrice.toFixed(5) :
                                     newPrice < 100 ? newPrice.toFixed(3) :
                                     newPrice.toFixed(2);

                // Update elements with animation
                priceElement.textContent = formattedPrice;

                // Remove any existing animation classes
                priceElement.classList.remove('price-up', 'price-down', 'price-changed');

                // Add animation based on price change direction
                if (newPrice > lastPrice) {
                    priceElement.classList.add('price-up');
                } else if (newPrice < lastPrice) {
                    priceElement.classList.add('price-down');
                } else {
                    priceElement.classList.add('price-changed');
                }

                // Update change display
                changeElement.textContent = `${(totalChange * 100).toFixed(2)}% ${totalChange >= 0 ? '↑' : '↓'}`;
                changeElement.className = `change ${totalChange >= 0 ? 'positive' : 'negative'}`;

                // Store current price for next comparison
                lastPrice = newPrice;

                // Schedule next update if element still exists in DOM
                if (element.isConnected) {
                    setTimeout(updateFn, updateInterval);
                }
            };

            // Start first update after a short delay
            setTimeout(updateFn, Math.random() * 3000 + 1000);
        }

        // Load existing wishlist items from Django context
        document.addEventListener('DOMContentLoaded', function() {
            const pairsList = document.querySelector('.pairs-list');

            // Debug: Log the number of wishlist items from the server
            console.log("Loading wishlist items from Django context");

            const wishlistItems = [
                {% for item in wishlist_items %}
                {
                    id: {{ item.id }},
                    symbol: "{{ item.symbol }}",
                    category: "{{ item.get_category_display }}",
                    price: {{ item.last_price|default:'0' }},
                    priceChange: {{ item.price_change|default:'0' }}
                },
                {% endfor %}
            ];

            // Debug: Log the wishlist items
            console.log("Wishlist items:", wishlistItems);

            // Clear any existing items first
            pairsList.innerHTML = '';

            // If no items, show empty state
            console.log("Checking if wishlist is empty:", wishlistItems.length);
            if (wishlistItems.length === 0 || (wishlistItems.length === 1 && !wishlistItems[0].id)) {
                console.log("Wishlist is empty, showing empty state");
                pairsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-content">
                            <i class="fas fa-star" style="font-size: 48px; color: #666;"></i>
                            <h3>No Favorites Yet</h3>
                            <p>Your wishlist is empty. Add pairs to track them here.</p>
                        </div>
                    </div>
                `;
                return;
            }

            console.log("Wishlist has items, proceeding to display them");

            // Add each item to the UI
            wishlistItems.forEach(item => {
                console.log("Processing wishlist item:", item);
                if (!item.id) {
                    console.log("Skipping item with no ID");
                    return; // Skip empty items
                }

                // Format the symbol for display (add / if needed)
                let displaySymbol = item.symbol;
                console.log("Original symbol:", displaySymbol);
                if (!displaySymbol.includes('/')) {
                    // Try to detect where to add the slash
                    if (displaySymbol.endsWith('USDT')) {
                        displaySymbol = displaySymbol.replace('USDT', '/USDT');
                    } else if (displaySymbol.endsWith('USD')) {
                        displaySymbol = displaySymbol.replace('USD', '/USD');
                    } else if (displaySymbol.endsWith('BTC')) {
                        displaySymbol = displaySymbol.replace('BTC', '/BTC');
                    } else if (displaySymbol.endsWith('ETH')) {
                        displaySymbol = displaySymbol.replace('ETH', '/ETH');
                    }
                    console.log("Formatted symbol:", displaySymbol);
                }

                const symbolId = displaySymbol.replace('/', '');

                // Format price based on value
                const numPrice = parseFloat(item.price);
                const formattedPrice = numPrice < 0.01 ? numPrice.toFixed(8) :
                                     numPrice < 1 ? numPrice.toFixed(5) :
                                     numPrice < 100 ? numPrice.toFixed(3) :
                                     numPrice.toFixed(2);

                // Create the UI element
                const pairItem = document.createElement('div');
                pairItem.className = 'pair-item';
                pairItem.setAttribute('data-symbol', symbolId);
                pairItem.setAttribute('data-category', item.category);
                pairItem.setAttribute('data-id', item.id);

                pairItem.innerHTML = `
                    <div class="pair-info">
                        <span class="symbol">${displaySymbol}</span>
                        <div class="value-container">
                            <span class="value-label">Price:</span>
                            <span class="main-value">${formattedPrice}</span>
                        </div>
                        <div class="value-container">
                            <span class="value-label">Change:</span>
                            <span class="change">${item.priceChange}% ${parseFloat(item.priceChange) >= 0 ? '↑' : '↓'}</span>
                        </div>
                    </div>
                    <div class="pair-actions">
                        <button class="action-button buy-button" onclick="showConfirmationModal('${symbolId}', ${numPrice}, 'BUY')">
                            <i class="fas fa-arrow-up"></i> Buy
                        </button>
                        <button class="action-button sell-button" onclick="showConfirmationModal('${symbolId}', ${numPrice}, 'SELL')">
                            <i class="fas fa-arrow-down"></i> Sell
                        </button>
                        <button class="action-button delete-button" onclick="removeFromWishlist('${symbolId}')">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                `;

                // Add to wishlist UI
                pairsList.appendChild(pairItem);

                // Setup real-time updates
                console.log("Setting up real-time updates for:", symbolId, "Category:", item.category);
                if (item.category === 'Cryptocurrency' && symbolId.includes('USDT')) {
                    console.log("Using Binance WebSocket for:", symbolId);
                    // Use Binance WebSocket for crypto
                    setupWebSocket(symbolId, pairItem);
                } else {
                    console.log("Using simulated updates for:", symbolId);
                    // Start simulated live updates for other categories
                    setupSimulatedLiveUpdates(pairItem, numPrice, item.category);
                }
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const pairs = [
                { id: 'EURUSDT', display: 'EUR/USDT' },
                { id: 'BTCUSDT', display: 'BTC/USDT' },
                { id: 'ETHUSDT', display: 'ETH/USDT' }
            ];
            const sockets = {};

            function formatPrice(price) {
                return parseFloat(price).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }

            function updatePairBox(pairId, price, change) {
                const box = document.getElementById(pairId);
                if (box) {
                    const priceElement = box.querySelector('.price');
                    const changeElement = box.querySelector('.change');

                    priceElement.textContent = `$ ${formatPrice(price)}`;

                    const changeValue = parseFloat(change);
                    const changeText = changeValue >= 0 ? `+${changeValue.toFixed(2)}%` : `${changeValue.toFixed(2)}%`;
                    changeElement.textContent = changeText;
                    changeElement.className = `change ${changeValue >= 0 ? 'positive' : 'negative'}`;
                }
            }

            // First get initial prices
            pairs.forEach(pair => {
                fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${pair.id}`)
                    .then(response => response.json())
                    .then(data => {
                        updatePairBox(pair.id, data.lastPrice, data.priceChangePercent);
                    })
                    .catch(error => console.error('Error fetching initial price:', error));

                // Setup WebSocket connection for live updates
                const socket = new WebSocket(`wss://stream.binance.com:9443/ws/${pair.id.toLowerCase()}@ticker`);

                socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    updatePairBox(pair.id, data.c, data.P);  // c = current price, P = price change percentage
                };

                socket.onerror = (error) => {
                    console.error(`WebSocket Error for ${pair.id}:`, error);
                };

                socket.onclose = () => {
                    console.log(`WebSocket Closed for ${pair.id}`);
                    // Attempt to reconnect after 5 seconds
                    setTimeout(() => {
                        console.log(`Attempting to reconnect ${pair.id}...`);
                        sockets[pair.id] = new WebSocket(`wss://stream.binance.com:9443/ws/${pair.id.toLowerCase()}@ticker`);
                    }, 5000);
                };

                sockets[pair.id] = socket;
            });
        });
    </script>

    <style>
        .top-pairs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .pair-box-link {
            text-decoration: none;
            flex: 1;
            min-width: 200px;
            transition: transform 0.2s;
        }

        .pair-box-link:hover {
            transform: translateY(-3px);
        }

        .pair-box {
            background: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            height: 100%;
        }

        .pair-box span {
            display: block;
        }

        .pair-box .pair-name {
            color: #000000;
        }

        .pair-box .price {
            font-size: 1.4em;
            font-weight: bold;
            margin: 8px 0;
            color: #2c3e50;
        }

        .pair-box .change {
            font-size: 0.9em;
            font-weight: 500;
        }

        .change.positive {
            color: #00c853;
        }

        .change.negative {
            color: #ff3d00;
        }

        @media (max-width: 768px) {
            .pair-box {
                min-width: 100%;
            }
        }
    </style>

    <div class="search-bar">
        <input type="text" placeholder="Search eg: EUR/USD, BTC">
        <i class="fas fa-search"></i>
    </div>

    <div class="tabs">
        <button class="tab active" data-tab="favorites">FAVORITES</button>
        <button class="tab" data-tab="all-symbols">ALL SYMBOLS</button>
    </div>

    <div class="pairs-list">
        <!-- Pairs will be dynamically added here -->
    </div>

    <div class="market-categories">
        <div class="market-category">
            <div class="category-header">
                <span>Crypto</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="category-content">
                <!-- Cryptocurrency data will be loaded dynamically -->
                <div class="loading-placeholder">Click to load cryptocurrency data</div>
            </div>
        </div>
        <div class="market-category">
            <div class="category-header">
                <span>Stocks</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="category-content">
                <!-- Stock data will be loaded dynamically -->
                <div class="loading-placeholder">Click to load stock data</div>
            </div>
        </div>
        <div class="market-category">
            <div class="category-header">
                <span>Indices</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="category-content">
                <!-- Indices data will be loaded dynamically -->
                <div class="loading-placeholder">Click to load indices data</div>
            </div>
        </div>
        <div class="market-category">
            <div class="category-header">
                <span>Commodities</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="category-content">
                <!-- Commodities data will be loaded dynamically -->
                <div class="loading-placeholder">Click to load commodities data</div>
            </div>
        </div>
        <div class="market-category">
            <div class="category-header">
                <span>Forex</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="category-content">
                <!-- Forex data will be loaded dynamically -->
                <div class="loading-placeholder">Click to load forex data</div>
            </div>
        </div>
    </div>
</div>

<!-- Add this HTML for the trading modal -->
<div id="tradingModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Place Order: <span id="selectedSymbol"></span></h2>
        <div class="current-price">
            <span>Current Market Price:</span>
            <span id="modalPrice">0.00</span>
        </div>
        <div class="trade-form">
            <div class="form-group">
                <label>Amount (USDT)</label>
                <input type="number" id="tradeAmount" min="10" step="1" placeholder="Enter amount">
            </div>
            <div class="form-group">
                <label>Stop Loss (%)</label>
                <input type="number" id="stopLoss" value="2" min="0.1" max="100" step="0.1">
            </div>
            <div class="form-group">
                <label>Take Profit (%)</label>
                <input type="number" id="takeProfit" value="4" min="0.1" max="100" step="0.1">
            </div>
            <div class="buttons">
                <button class="buy-btn" onclick="placeTrade('BUY')">BUY</button>
                <button class="sell-btn" onclick="placeTrade('SELL')">SELL</button>
            </div>
        </div>
    </div>
</div>

<!-- Add this HTML for the confirmation modal -->
<div id="confirmationModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">×</span>
        <h2>Confirm Order</h2>
        <div class="trade-details">
            <div class="detail-row">
                <span class="detail-label">Symbol</span>
                <span class="detail-value" id="confirmSymbol">BTC/USDT</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Order Type</span>
                <span class="detail-value" id="confirmOrderType">BUY</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Quantity</span>
                <div class="quantity-wrapper">
                    <input type="number" id="quantityInput" class="quantity-input" min="0.00001" step="0.00001" value="0.01">
                    <span class="currency-symbol">BTC</span>
                </div>
            </div>
            <div class="detail-row">
                <span class="detail-label">Price</span>
                <span class="detail-value" id="confirmPrice">93235.58</span>
            </div>
            <div class="detail-row total-amount">
                <span class="detail-label">Total Amount</span>
                <span class="detail-value" id="confirmTotal">932.36</span>
            </div>
        </div>
        <div class="confirmation-buttons">
            <button class="cancel-btn">Cancel</button>
            <button class="proceed-btn">Confirm Order</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab switching functionality
        const tabs = document.querySelectorAll('.tab');
        const pairsList = document.querySelector('.pairs-list');
        const marketCategories = document.querySelector('.market-categories');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                tab.classList.add('active');

                // Show/hide content based on selected tab
                if (tab.dataset.tab === 'favorites') {
                    pairsList.style.display = 'flex';
                    marketCategories.style.display = 'none';
                } else {
                    pairsList.style.display = 'none';
                    marketCategories.style.display = 'block';
                }
            });
        });

        // Setup category click handlers
        document.querySelectorAll('.market-category').forEach(category => {
            const header = category.querySelector('.category-header');
            const content = category.querySelector('.category-content');
            const categoryName = header.querySelector('span').textContent;

            // Set data-category attribute
            category.setAttribute('data-category', categoryName);

            header.addEventListener('click', function() {
                const isActive = content.classList.contains('active');

                // Toggle active class
                header.classList.toggle('active');
                content.classList.toggle('active');

                // Rotate chevron icon
                const icon = header.querySelector('i');
                icon.style.transform = isActive ? 'rotate(0deg)' : 'rotate(180deg)';

                // Load data if expanding and not already loaded
                if (!isActive && content.getAttribute('data-loaded') !== 'true') {
                    loadCategoryData(categoryName, content);
                }
            });
        });

        // Click handler for loading placeholders
        document.querySelectorAll('.loading-placeholder').forEach(placeholder => {
            placeholder.addEventListener('click', function() {
                const content = this.parentElement;
                const categoryName = content.parentElement.getAttribute('data-category');
                loadCategoryData(categoryName, content);
            });
        });

        // Function to load data for a category
        function loadCategoryData(categoryName, container) {
            // Check if already loaded
            if (container.getAttribute('data-loaded') === 'true') {
                return;
            }

            // Create loading indicator
            container.innerHTML = '';
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'loading-indicator';
            loadingIndicator.textContent = `Loading ${categoryName} data...`;
            container.appendChild(loadingIndicator);

            // Load based on category
            switch(categoryName) {
                case 'Crypto':
                    loadCryptoData(container);
                    break;
                case 'Stocks':
                    loadStockData(container);
                    break;
                case 'Indices':
                    loadIndicesData(container);
                    break;
                case 'Commodities':
                    loadCommoditiesData(container);
                    break;
                case 'Forex':
                    loadForexData(container);
                    break;
            }

            // Mark as loaded
            container.setAttribute('data-loaded', 'true');
        }

        // Function to load crypto data via Binance API
        function loadCryptoData(container) {
            // Show loading indicator first
            container.innerHTML = '<div class="loading-indicator">Loading all cryptocurrencies...</div>';

            // Try to get all available crypto pairs from Binance
            fetch('https://api.binance.com/api/v3/ticker/price')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API response: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    container.innerHTML = '';

                    // Filter only for USDT pairs which are cryptocurrencies
                    const cryptoPairs = data.filter(item => item.symbol.endsWith('USDT'));

                    if (cryptoPairs.length === 0) {
                        throw new Error("No cryptocurrency data found");
                    }

                    // Sort by symbol name
                    cryptoPairs.sort((a, b) => a.symbol.localeCompare(b.symbol));

                    // Add search for the large list
                    const searchBox = document.createElement('div');
                    searchBox.className = 'crypto-search';
                    searchBox.innerHTML = `
                        <input type="text" placeholder="Filter cryptocurrencies..." class="crypto-search-input">
                    `;
                    container.appendChild(searchBox);

                    // Create container for the crypto items
                    const cryptoListContainer = document.createElement('div');
                    cryptoListContainer.className = 'crypto-list';
                    container.appendChild(cryptoListContainer);

                    // Create elements for each crypto
                    cryptoPairs.forEach(item => {
                        const displaySymbol = item.symbol.replace('USDT', '/USDT');
                        const price = parseFloat(item.price);

                        // Format price with appropriate decimals based on value
                        const formattedPrice = price < 0.01 ? price.toFixed(8) :
                                             price < 1 ? price.toFixed(5) :
                                             price < 100 ? price.toFixed(3) :
                                             price.toFixed(2);

                        addSymbolItem(cryptoListContainer, displaySymbol, formattedPrice, 'Crypto');
                    });

                    // Add count of cryptocurrencies
                    const countInfo = document.createElement('div');
                    countInfo.className = 'crypto-count';
                    countInfo.textContent = `Showing ${cryptoPairs.length} cryptocurrencies`;
                    countInfo.style.textAlign = 'center';
                    countInfo.style.padding = '10px';
                    countInfo.style.color = '#999';
                    countInfo.style.fontSize = '0.9em';
                    container.appendChild(countInfo);

                    // Setup search functionality
                    const searchInput = searchBox.querySelector('.crypto-search-input');
                    searchInput.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase();
                        const items = cryptoListContainer.querySelectorAll('.symbol-item');
                        let visibleCount = 0;

                        items.forEach(item => {
                            const symbol = item.querySelector('span:first-child').textContent.toLowerCase();
                            if (symbol.includes(searchTerm)) {
                                item.style.display = 'flex';
                                visibleCount++;
                            } else {
                                item.style.display = 'none';
                            }
                        });

                        countInfo.textContent = `Showing ${visibleCount} of ${cryptoPairs.length} cryptocurrencies`;
                    });
                })
                .catch(error => {
                    console.error('Error fetching crypto data:', error);

                    // Fall back to mock data if the API call fails
                    useFallbackCryptoData(container);
                });
        }

        // Fallback function for crypto data when API fails
        function useFallbackCryptoData(container) {
            const fallbackData = [
                { symbol: 'BTC/USDT', price: 93838.33, change: 1.59 },
                { symbol: 'ETH/USDT', price: 1780.65, change: 2.01 },
                { symbol: 'BNB/USDT', price: 571.20, change: 0.85 },
                { symbol: 'XRP/USDT', price: 0.47852, change: -1.23 },
                { symbol: 'SOL/USDT', price: 169.43, change: 3.25 },
                { symbol: 'ADA/USDT', price: 0.35621, change: -0.45 },
                { symbol: 'DOGE/USDT', price: 0.12045, change: 1.05 },
                { symbol: 'DOT/USDT', price: 5.83, change: 0.25 },
                { symbol: 'AVAX/USDT', price: 27.56, change: 4.32 },
                { symbol: 'LINK/USDT', price: 14.23, change: 2.76 },
                { symbol: 'MATIC/USDT', price: 0.52341, change: -0.87 },
                { symbol: 'UNI/USDT', price: 7.84, change: 1.12 },
                { symbol: 'ATOM/USDT', price: 6.31, change: -0.32 },
                { symbol: 'LTC/USDT', price: 68.25, change: 0.98 },
                { symbol: 'SHIB/USDT', price: 0.000018, change: 3.45 },
                { symbol: 'TRX/USDT', price: 0.12568, change: 0.43 },
                { symbol: 'XLM/USDT', price: 0.11021, change: -0.18 },
                { symbol: 'NEAR/USDT', price: 5.78, change: 2.56 },
                { symbol: 'FTM/USDT', price: 0.63482, change: 5.34 },
                { symbol: 'ALGO/USDT', price: 0.15674, change: -1.23 },
                { symbol: 'ICP/USDT', price: 8.41, change: 3.78 },
                { symbol: 'VET/USDT', price: 0.024567, change: 0.87 },
                { symbol: 'FIL/USDT', price: 4.82, change: 1.45 },
                { symbol: 'APE/USDT', price: 1.47, change: -2.13 },
                { symbol: 'SAND/USDT', price: 0.48762, change: 0.56 },
                { symbol: 'AAVE/USDT', price: 88.62, change: 1.23 },
                { symbol: 'EGLD/USDT', price: 36.45, change: -0.78 },
                { symbol: 'AXS/USDT', price: 7.25, change: 2.45 },
                { symbol: 'MANA/USDT', price: 0.47856, change: 1.12 },
                { symbol: 'GRT/USDT', price: 0.17854, change: 3.45 },
                { symbol: 'HBAR/USDT', price: 0.078854, change: 0.56 },
                { symbol: 'EOS/USDT', price: 0.73452, change: -1.23 },
                { symbol: 'XTZ/USDT', price: 0.87456, change: 0.78 },
                { symbol: 'THETA/USDT', price: 1.23456, change: 2.13 },
                { symbol: 'FLOW/USDT', price: 0.78546, change: 1.45 },
                { symbol: 'KCS/USDT', price: 10.05, change: 3.21 },
                { symbol: 'CAKE/USDT', price: 2.45, change: -0.56 },
                { symbol: 'ZEC/USDT', price: 28.76, change: 1.23 },
                { symbol: 'NEO/USDT', price: 12.78, change: 2.56 },
                { symbol: 'LUNA/USDT', price: 0.45765, change: 5.67 },
                { symbol: 'ATOM/USDT', price: 7.89, change: 0.43 },
                { symbol: 'CRO/USDT', price: 0.087654, change: -0.78 },
                { symbol: 'DASH/USDT', price: 30.56, change: 1.23 },
                { symbol: 'WAVES/USDT', price: 2.13, change: 3.45 },
                { symbol: 'ZIL/USDT', price: 0.023456, change: 0.87 },
                { symbol: 'ENJ/USDT', price: 0.34567, change: 1.56 },
                { symbol: 'CHZ/USDT', price: 0.12456, change: 2.34 },
                { symbol: 'BAT/USDT', price: 0.23456, change: -1.23 },
                { symbol: 'ONE/USDT', price: 0.012345, change: 0.87 }
            ];

            container.innerHTML = '';

            // Add search for the large list
            const searchBox = document.createElement('div');
            searchBox.className = 'crypto-search';
            searchBox.innerHTML = `
                <input type="text" placeholder="Filter cryptocurrencies..." class="crypto-search-input">
            `;
            container.appendChild(searchBox);

            // Create container for the crypto items
            const cryptoListContainer = document.createElement('div');
            cryptoListContainer.className = 'crypto-list';
            container.appendChild(cryptoListContainer);

            fallbackData.forEach(item => {
                // Add a little randomness to the static data
                const randomFactor = 1 + ((Math.random() * 2 - 1) * 0.005); // ±0.5%
                const adjustedPrice = item.price * randomFactor;

                // Format price with appropriate decimals based on value
                const formattedPrice = adjustedPrice < 0.01 ? adjustedPrice.toFixed(8) :
                                     adjustedPrice < 1 ? adjustedPrice.toFixed(5) :
                                     adjustedPrice < 100 ? adjustedPrice.toFixed(3) :
                                     adjustedPrice.toFixed(2);

                addSymbolItem(cryptoListContainer, item.symbol, formattedPrice, 'Crypto');
            });

            // Add count of cryptocurrencies
            const countInfo = document.createElement('div');
            countInfo.className = 'crypto-count';
            countInfo.textContent = `Showing ${fallbackData.length} cryptocurrencies (cached data)`;
            countInfo.style.textAlign = 'center';
            countInfo.style.padding = '10px';
            countInfo.style.color = '#999';
            countInfo.style.fontSize = '0.9em';
            container.appendChild(countInfo);

            // Setup search functionality
            const searchInput = searchBox.querySelector('.crypto-search-input');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const items = cryptoListContainer.querySelectorAll('.symbol-item');
                let visibleCount = 0;

                items.forEach(item => {
                    const symbol = item.querySelector('span:first-child').textContent.toLowerCase();
                    if (symbol.includes(searchTerm)) {
                        item.style.display = 'flex';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                countInfo.textContent = `Showing ${visibleCount} of ${fallbackData.length} cryptocurrencies (cached data)`;
            });

            // Add a note about using fallback data
            const fallbackNote = document.createElement('div');
            fallbackNote.className = 'error-message';
            fallbackNote.innerHTML = 'Using cached data. Live API connection failed.';
            fallbackNote.style.backgroundColor = '#1f2130';
            fallbackNote.style.padding = '8px';
            fallbackNote.style.marginTop = '10px';
            fallbackNote.style.fontSize = '0.8em';
            fallbackNote.style.color = '#999';
            fallbackNote.style.textAlign = 'center';
            container.appendChild(fallbackNote);
        }

        // Function to load stock data
        function loadStockData(container) {
            const stockSymbols = [
                'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'META', 'TSLA', 'NVDA', 'JPM', 'V',
                'WMT', 'JNJ', 'PG', 'MA', 'HD', 'BAC', 'DIS', 'ADBE', 'CRM', 'NFLX',
                'KO', 'PEP', 'CSCO', 'XOM', 'INTC', 'AMD', 'PFE', 'NKE', 'MCD', 'PYPL'
            ];

            // For demonstration, we'll simulate API data
            // In production, use a real stocks API like Alpha Vantage, FinnHub, etc.

            setTimeout(() => {
                container.innerHTML = '';

                stockSymbols.forEach(symbol => {
                    let basePrice;
                    switch(symbol) {
                        case 'AAPL': basePrice = 170; break;
                        case 'MSFT': basePrice = 380; break;
                        case 'GOOGL': basePrice = 140; break;
                        case 'AMZN': basePrice = 170; break;
                        case 'META': basePrice = 450; break;
                        case 'TSLA': basePrice = 240; break;
                        case 'NVDA': basePrice = 100; break;
                        default: basePrice = Math.random() * 200 + 50;
                    }

                    const price = (basePrice + (Math.random() * basePrice * 0.1)).toFixed(2);
                    addSymbolItem(container, symbol, price, 'Stocks');
                });
            }, 500);
        }

        // Function to load indices data
        function loadIndicesData(container) {
            const indices = [
                { symbol: 'S&P 500', id: '.SPX' },
                { symbol: 'NASDAQ', id: '.IXIC' },
                { symbol: 'DOW', id: '.DJI' },
                { symbol: 'FTSE 100', id: '.FTSE' },
                { symbol: 'DAX', id: '.GDAXI' },
                { symbol: 'Nikkei 225', id: '.N225' },
                { symbol: 'Hang Seng', id: '.HSI' },
                { symbol: 'Shanghai Comp', id: '.SSEC' },
                { symbol: 'CAC 40', id: '.FCHI' },
                { symbol: 'Nifty 50', id: '.NSEI' },
                { symbol: 'KOSPI', id: '.KS11' }
            ];

            setTimeout(() => {
                container.innerHTML = '';

                indices.forEach(index => {
                    const baseValue = index.symbol === 'S&P 500' ? 5000 :
                                    index.symbol === 'NASDAQ' ? 16000 :
                                    index.symbol === 'DOW' ? 38000 :
                                    index.symbol === 'FTSE 100' ? 7500 :
                                    index.symbol === 'DAX' ? 18000 :
                                    index.symbol === 'Nikkei 225' ? 38000 :
                                    index.symbol === 'Hang Seng' ? 16500 :
                                    index.symbol === 'Shanghai Comp' ? 3000 :
                                    index.symbol === 'CAC 40' ? 7500 :
                                    index.symbol === 'Nifty 50' ? 22500 :
                                    2500; // Default for others

                    const price = (baseValue + (Math.random() * 200 - 100)).toFixed(2);
                    addSymbolItem(container, index.symbol, price, 'Indices');
                });
            }, 500);
        }

        // Function to load commodities data
        function loadCommoditiesData(container) {
            const commodities = [
                { symbol: 'GOLD', id: 'XAUUSD' },
                { symbol: 'SILVER', id: 'XAGUSD' },
                { symbol: 'OIL', id: 'USOIL' },
                { symbol: 'NATURAL GAS', id: 'NATGAS' },
                { symbol: 'COPPER', id: 'COPPER' },
                { symbol: 'PLATINUM', id: 'XPTUSD' },
                { symbol: 'PALLADIUM', id: 'XPDUSD' },
                { symbol: 'WHEAT', id: 'WHEAT' },
                { symbol: 'CORN', id: 'CORN' },
                { symbol: 'SOYBEANS', id: 'SOYBEAN' }
            ];

            setTimeout(() => {
                container.innerHTML = '';

                commodities.forEach(commodity => {
                    let price;
                    switch(commodity.symbol) {
                        case 'GOLD': price = (2000 + Math.random() * 100).toFixed(2); break;
                        case 'SILVER': price = (23 + Math.random() * 2).toFixed(2); break;
                        case 'OIL': price = (76 + Math.random() * 8).toFixed(2); break;
                        case 'NATURAL GAS': price = (2 + Math.random() * 0.5).toFixed(3); break;
                        case 'COPPER': price = (4 + Math.random() * 0.5).toFixed(3); break;
                        case 'PLATINUM': price = (950 + Math.random() * 100).toFixed(2); break;
                        case 'PALLADIUM': price = (950 + Math.random() * 100).toFixed(2); break;
                        case 'WHEAT': price = (550 + Math.random() * 50).toFixed(2); break;
                        case 'CORN': price = (450 + Math.random() * 50).toFixed(2); break;
                        case 'SOYBEANS': price = (1200 + Math.random() * 100).toFixed(2); break;
                        default: price = (100 + Math.random() * 900).toFixed(2);
                    }

                    addSymbolItem(container, commodity.symbol, price, 'Commodities');
                });
            }, 500);
        }

        // Function to load forex data
        function loadForexData(container) {
            const forexPairs = [
                'EUR/USD', 'GBP/USD', 'USD/JPY', 'AUD/USD', 'USD/CAD',
                'USD/CHF', 'NZD/USD', 'EUR/GBP', 'EUR/JPY', 'GBP/JPY',
                'USD/CNY', 'USD/HKD', 'USD/SGD', 'USD/INR', 'USD/MXN',
                'USD/ZAR', 'USD/TRY', 'USD/BRL', 'USD/SEK', 'USD/DKK'
            ];

            // Show loading indicator
            container.innerHTML = '<div class="loading-indicator">Loading forex data...</div>';

            // Process each forex pair sequentially with Alpha Vantage API
            const apiKey = 'QHMIRSKIIHDGNSQF';
            let processedCount = 0;

            // Clear the container
            container.innerHTML = '';

            // Process forex pairs one by one (Alpha Vantage has strict rate limits)
            function processNextPair(index) {
                if (index >= forexPairs.length) return;

                const pair = forexPairs[index];
                const fromSymbol = pair.split('/')[0];
                const toSymbol = pair.split('/')[1];

                const url = `https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=${fromSymbol}&to_currency=${toSymbol}&apikey=${apiKey}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        processedCount++;

                        // Check if we have valid data
                        if (data["Realtime Currency Exchange Rate"]) {
                            const exchangeData = data["Realtime Currency Exchange Rate"];
                            const rate = parseFloat(exchangeData["5. Exchange Rate"]).toFixed(4);
                            addSymbolItem(container, pair, rate, 'Forex');
                        } else {
                            // If we hit API limit or other error, use fallback data
                            let fallbackRate;
                            switch(pair) {
                                case 'EUR/USD': fallbackRate = 1.08; break;
                                case 'GBP/USD': fallbackRate = 1.26; break;
                                case 'USD/JPY': fallbackRate = 149; break;
                                case 'AUD/USD': fallbackRate = 0.65; break;
                                case 'USD/CAD': fallbackRate = 1.37; break;
                                case 'USD/CHF': fallbackRate = 0.90; break;
                                case 'NZD/USD': fallbackRate = 0.60; break;
                                case 'EUR/GBP': fallbackRate = 0.86; break;
                                case 'EUR/JPY': fallbackRate = 161; break;
                                case 'GBP/JPY': fallbackRate = 188; break;
                                case 'USD/CNY': fallbackRate = 7.2; break;
                                case 'USD/HKD': fallbackRate = 7.8; break;
                                case 'USD/SGD': fallbackRate = 1.35; break;
                                case 'USD/INR': fallbackRate = 83; break;
                                case 'USD/MXN': fallbackRate = 17; break;
                                case 'USD/ZAR': fallbackRate = 18.5; break;
                                case 'USD/TRY': fallbackRate = 32; break;
                                case 'USD/BRL': fallbackRate = 5.1; break;
                                case 'USD/SEK': fallbackRate = 10.5; break;
                                case 'USD/DKK': fallbackRate = 6.9; break;
                                default: fallbackRate = 1.0;
                            }
                            const fallbackRateWithNoise = (fallbackRate + (Math.random() * 0.01 - 0.005)).toFixed(4);
                            addSymbolItem(container, pair, fallbackRateWithNoise, 'Forex');
                            console.log(`Using fallback data for ${pair} (API limit reached or error)`);
                        }

                        // Process next pair with delay to avoid API rate limit
                        setTimeout(() => {
                            processNextPair(index + 1);
                        }, 1500);
                    })
                    .catch(error => {
                        console.error(`Error fetching data for ${pair}:`, error);

                        // Use fallback data in case of error
                        const fallbackRate = (Math.random() * 10 + 1).toFixed(4);
                        addSymbolItem(container, pair, fallbackRate, 'Forex');

                        // Continue with next pair
                        setTimeout(() => {
                            processNextPair(index + 1);
                        }, 1500);
                    });
            }

            // Start processing pairs
            processNextPair(0);
        }

        // Helper function to create symbol items
        function addSymbolItem(container, symbol, price, category) {
            const item = document.createElement('div');
            item.className = 'symbol-item';

            // For crypto items, fetch additional price change data
            if (category === 'Crypto' && symbol.includes('/USDT')) {
                // Create basic structure first
            item.innerHTML = `
                <span>${symbol}</span>
                <span>${price}</span>
                    <span class="symbol-change">Loading...</span>
                <button class="add-to-wishlist"><i class="fas fa-plus"></i> Add to Wishlist</button>
            `;

                // Add to container immediately so user sees something
                container.appendChild(item);

                // Try to fetch 24h price change data from Binance
                const pureSymbol = symbol.replace('/', '');
                fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${pureSymbol}`)
                    .then(response => response.json())
                    .then(data => {
                        const changeElement = item.querySelector('.symbol-change');
                        if (changeElement && data.priceChangePercent) {
                            const changeValue = parseFloat(data.priceChangePercent);
                            changeElement.textContent = `${changeValue >= 0 ? '+' : ''}${changeValue.toFixed(2)}%`;
                            changeElement.className = `symbol-change ${changeValue >= 0 ? 'positive' : 'negative'}`;
                        }
                    })
                    .catch(() => {
                        // If API call fails, show a default or random change
                        const changeElement = item.querySelector('.symbol-change');
                        if (changeElement) {
                            // Generate a random change between -3% and +3% if data can't be loaded
                            const randomChange = (Math.random() * 6 - 3).toFixed(2);
                            const isPositive = parseFloat(randomChange) >= 0;
                            changeElement.textContent = `${isPositive ? '+' : ''}${randomChange}%`;
                            changeElement.className = `symbol-change ${isPositive ? 'positive' : 'negative'}`;
                        }
                    });
            } else {
                // For non-crypto or fallback, use simple structure
                item.innerHTML = `
                    <span>${symbol}</span>
                    <span>${price}</span>
                    <button class="add-to-wishlist"><i class="fas fa-plus"></i> Add to Wishlist</button>
                `;
                container.appendChild(item);
            }

            // Add to wishlist button click event
            const addButton = item.querySelector('.add-to-wishlist');
            addButton.addEventListener('click', function(e) {
                e.stopPropagation();
                addToWishlist(symbol, price, category);
            });

            // Item click event (for trading)
            item.addEventListener('click', () => {
                const tradingSymbol = symbol.replace('/', '');
                // Skip first modal, go directly to confirmation
                showConfirmationModal(tradingSymbol, price, 'BUY');
            });
        }

        // Function to add to wishlist
        function addToWishlist(symbol, price, category) {
            // Check if already in wishlist
            const symbolId = symbol.replace('/', '');
            if (document.querySelector(`.pair-item[data-symbol="${symbolId}"]`)) {
                showToast(`${symbol} is already in your wishlist`, 'info');
                return;
            }

            // Remove empty state message if it exists
            const emptyState = document.querySelector('.pairs-list .empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            // Create pair item for UI display
            const pairItem = document.createElement('div');
            pairItem.className = 'pair-item';
            pairItem.setAttribute('data-symbol', symbolId);
            pairItem.setAttribute('data-category', category);

            // Format price based on value
            const numPrice = parseFloat(price);
            const formattedPrice = numPrice < 0.01 ? numPrice.toFixed(8) :
                                 numPrice < 1 ? numPrice.toFixed(5) :
                                 numPrice < 100 ? numPrice.toFixed(3) :
                                 numPrice.toFixed(2);

            pairItem.innerHTML = `
                <div class="pair-info">
                    <span class="symbol">${symbol}</span>
                    <div class="value-container">
                        <span class="value-label">Price:</span>
                    <span class="main-value">${formattedPrice}</span>
                    </div>
                    <div class="value-container">
                        <span class="value-label">Change:</span>
                    <span class="change">0.00% ↑</span>
                    </div>
                </div>
                <div class="pair-actions">
                    <button class="action-button buy-button" onclick="showConfirmationModal('${symbolId}', ${numPrice}, 'BUY')">
                        <i class="fas fa-arrow-up"></i> Buy
                    </button>
                    <button class="action-button sell-button" onclick="showConfirmationModal('${symbolId}', ${numPrice}, 'SELL')">
                        <i class="fas fa-arrow-down"></i> Sell
                    </button>
                    <button class="action-button delete-button" onclick="removeFromWishlist('${symbolId}')">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            `;

            // Add to wishlist UI
            document.querySelector('.pairs-list').appendChild(pairItem);

            // Also save to database
            fetch('/api/add_to_wishlist/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    symbol: symbol,
                    price: numPrice,
                    category: category
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`${symbol} added to wishlist`, 'success');
                    // Set database ID on the element
                    if (data.item_id) {
                        pairItem.setAttribute('data-id', data.item_id);
                    }

                    // Switch to Favorites tab
                    document.querySelector('[data-tab="favorites"]').click();

                    // Setup real-time updates for the item based on category
                    if (category === 'Crypto' && symbol.includes('/USDT')) {
                        // Use Binance WebSocket for crypto
                        setupWebSocket(symbolId, pairItem);
                    } else {
                        // Start simulated live updates for other categories
                        setupSimulatedLiveUpdates(pairItem, numPrice, category);
                    }
                } else {
                    showToast(data.message || 'Failed to save to database', 'error');
                }
            })
            .catch(error => {
                console.error('Error saving to wishlist:', error);
                showToast('Failed to save to database', 'error');
            });
        }

        // Helper function to get CSRF token from cookies
        function getCsrfToken() {
            const name = 'csrftoken';
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith(name))
                ?.split('=')[1];
            return cookieValue;
        }

        // This section was moved to the top of the script

        // Function to show toast message
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast-message ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    });

    // Function to remove from wishlist (needs to be global for the onclick handlers)
    function removeFromWishlist(symbol) {
        const item = document.querySelector(`.pair-item[data-symbol="${symbol}"]`);
        if (!item) return;

        if (confirm('Are you sure you want to remove this item from your wishlist?')) {
            // Send request to server to remove item from database
            fetch('/api/remove_from_wishlist/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    symbol: symbol
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Animate removal
                    item.style.opacity = '0';
                    item.style.transform = 'translateX(-20px)';

                    // Remove after animation
                    setTimeout(() => {
                        item.remove();

                        // Check if wishlist is empty
                        const wishlist = document.querySelector('.pairs-list');
                        const remainingItems = wishlist.querySelectorAll('.pair-item');
                        if (remainingItems.length === 0) {
                            wishlist.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-state-content">
                                        <i class="fas fa-star" style="font-size: 48px; color: #666;"></i>
                                        <h3>No Favorites Yet</h3>
                                        <p>Your wishlist is empty. Add pairs to track them here.</p>
                                    </div>
                                </div>
                            `;
                        }
                    }, 300);

                    showToast('Item removed from wishlist', 'success');
                } else {
                    showToast(data.message || 'Failed to remove from database', 'error');
                }
            })
            .catch(error => {
                console.error('Error removing from wishlist:', error);
                showToast('Failed to remove from database', 'error');
            });
        }
    }

    // Function to open the trading modal
    function openTradeModal(symbol, price, orderType) {
        const modal = document.getElementById('tradingModal');
        const selectedSymbolEl = document.getElementById('selectedSymbol');
        const modalPriceEl = document.getElementById('modalPrice');

        if (modal && selectedSymbolEl && modalPriceEl) {
            // Format the symbol for display
            const displaySymbol = symbol.includes('/') ? symbol : symbol.replace(/(USDT|USD|BTC|ETH)$/, '/$1');

            // Set modal content
            selectedSymbolEl.textContent = displaySymbol;
            modalPriceEl.textContent = typeof price === 'number' ? price.toFixed(2) : price;

            // Show the modal
            modal.style.display = 'block';

            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close');
            closeButtons.forEach(button => {
                button.onclick = function() {
                    modal.style.display = 'none';
                }
            });

            // Close when clicking outside the modal
            window.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        } else {
            console.error('Trading modal elements not found');
        }
    }

    // Function to place a trade (placeholder for now)
    function placeTrade(orderType) {
        const symbol = document.getElementById('selectedSymbol').textContent;
        const amount = document.getElementById('tradeAmount').value;
        const stopLoss = document.getElementById('stopLoss').value;
        const takeProfit = document.getElementById('takeProfit').value;

        // For now, just show a confirmation modal
        const confirmModal = document.getElementById('confirmationModal');
        const tradingModal = document.getElementById('tradingModal');

        if (confirmModal && tradingModal) {
            // Set confirmation details
            document.getElementById('confirmSymbol').textContent = symbol;
            document.getElementById('confirmOrderType').textContent = orderType;

            const price = parseFloat(document.getElementById('modalPrice').textContent);
            document.getElementById('confirmPrice').textContent = price.toFixed(2);

            // Set currency symbol based on the trading pair
            const currencySymbol = symbol.split('/')[0];
            document.querySelector('.currency-symbol').textContent = currencySymbol;

            // Calculate initial quantity based on amount if provided
            const quantityInput = document.getElementById('quantityInput');
            if (amount && !isNaN(amount) && price > 0) {
                const calculatedQuantity = (parseFloat(amount) / price).toFixed(8);
                quantityInput.value = calculatedQuantity;
            }

            // Update total based on current quantity
            updateTotalAmount();

            // Add input event to quantity input to update total in real-time
            quantityInput.addEventListener('input', updateTotalAmount);

            // Function to update total amount
            function updateTotalAmount() {
                const quantity = parseFloat(quantityInput.value);
                if (!isNaN(quantity) && price > 0) {
                    const total = (quantity * price).toFixed(2);
                    document.getElementById('confirmTotal').textContent = total;
                }
            }

            // Hide trading modal and show confirmation
            tradingModal.style.display = 'none';
            confirmModal.style.display = 'block';

            // Setup confirmation buttons
            const cancelBtn = confirmModal.querySelector('.cancel-btn');
            const proceedBtn = confirmModal.querySelector('.proceed-btn');
            const closeBtn = confirmModal.querySelector('.close');

            cancelBtn.onclick = function() {
                confirmModal.style.display = 'none';
                tradingModal.style.display = 'block';
                // Remove event listener when closing
                quantityInput.removeEventListener('input', updateTotalAmount);
            }

            proceedBtn.onclick = function() {
                // In a real app, this would send the order to a backend
                confirmModal.style.display = 'none';
                const total = document.getElementById('confirmTotal').textContent;
                showToast(`${orderType} order for ${symbol} placed successfully for $${total}!`, 'success');
                // Remove event listener when closing
                quantityInput.removeEventListener('input', updateTotalAmount);
            }

            closeBtn.onclick = function() {
                confirmModal.style.display = 'none';
                // Remove event listener when closing
                quantityInput.removeEventListener('input', updateTotalAmount);
            }
        }
    }

    // Add CSS for the new crypto search
    function addCryptoStyles() {
        const styleTag = document.createElement('style');
        styleTag.textContent = `
            .crypto-search {
                margin-bottom: 15px;
                padding: 0 10px;
            }

            .crypto-search-input {
                width: 100%;
                padding: 10px 15px;
                background: #1f2330;
                border: 1px solid #2a2d3e;
                border-radius: 6px;
                color: #fff;
                font-size: 14px;
            }

            .crypto-search-input:focus {
                outline: none;
                border-color: #3385ff;
            }

            .crypto-list {
                max-height: 350px;
                overflow-y: auto;
            }

            .crypto-list::-webkit-scrollbar {
                width: 6px;
            }

            .crypto-list::-webkit-scrollbar-track {
                background: #0a0c12;
            }

            .crypto-list::-webkit-scrollbar-thumb {
                background: #2a2d3e;
                border-radius: 3px;
            }

            .crypto-list::-webkit-scrollbar-thumb:hover {
                background: #3385ff;
            }
        `;
        document.head.appendChild(styleTag);
    }

    // Call the function after DOM content loaded
    document.addEventListener('DOMContentLoaded', function() {
        addCryptoStyles();
        // ... rest of the existing code
    });

    // Create a new function to show confirmation directly
    function showConfirmationModal(symbol, price, orderType) {
        // Redirect to analytics page with the symbol parameter
        window.location.href = `/analytics/?symbol=${symbol}`;
    }

    // Function to show a success message after order confirmation
    function showOrderSuccessMessage(orderType, symbol, quantity, currencySymbol, price, total) {
        // Create success message element
        const successOverlay = document.createElement('div');
        successOverlay.className = 'success-overlay';

        // Set different color based on order type
        const orderColor = orderType === 'BUY' ? '#4CAF50' : '#f44336';
        const orderIcon = orderType === 'BUY' ? 'fa-arrow-up' : 'fa-arrow-down';

        successOverlay.innerHTML = `
            <div class="success-popup" style="border-top: 5px solid ${orderColor}">
                <div class="success-icon" style="background-color: ${orderColor}20; color: ${orderColor}">
                    <i class="fas ${orderIcon}"></i>
                </div>
                <h3>${orderType} ORDER SUCCESSFUL</h3>
                <div class="success-details">
                    <div class="success-row">
                        <span>Symbol:</span>
                        <span>${symbol}</span>
                    </div>
                    <div class="success-row">
                        <span>Amount:</span>
                        <span>${quantity} ${currencySymbol}</span>
                    </div>
                    <div class="success-row">
                        <span>Price:</span>
                        <span>$${price.toFixed(2)}</span>
                    </div>
                    <div class="success-row total">
                        <span>Total:</span>
                        <span>$${total}</span>
                    </div>
                </div>
                <button class="close-success">GOT IT</button>
            </div>
        `;

        // Add to body
        document.body.appendChild(successOverlay);

        // Animate in
        setTimeout(() => {
            successOverlay.classList.add('visible');
        }, 50);

        // Handle close button
        const closeButton = successOverlay.querySelector('.close-success');
        closeButton.addEventListener('click', () => {
            successOverlay.classList.remove('visible');
            setTimeout(() => {
                successOverlay.remove();
            }, 300);
        });

        // Auto close after 5 seconds
        setTimeout(() => {
            if (document.body.contains(successOverlay)) {
                successOverlay.classList.remove('visible');
                setTimeout(() => {
                    if (document.body.contains(successOverlay)) {
                        successOverlay.remove();
                    }
                }, 300);
            }
        }, 5000);
    }
</script>
{% endblock %}