{% extends 'base.html' %}
{% load static %}

{% block title %}Trading History - TradePro{% endblock %}

{% block extra_css %}
<style>
    :root {
        --bg-primary: #1a1c25;
        --bg-secondary: #242631;
        --text-primary: #ffffff;
        --text-secondary: #a0a3bd;
        --accent-blue: #2962ff;
        --accent-green: #00c853;
        --accent-red: #ff3d57;
        --border-color: #2f3241;
    }
    /* Add global text color */
    body {
        color: var(--text-primary);
    }
    .history-container {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        color: var(--text-primary);
    }
    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .history-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--text-primary);
    }
    .history-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-bottom: 20px;
        color: var(--text-primary);
    }
    .history-table th {
        background: var(--bg-primary);
        padding: 12px 16px;
        text-align: left;
        font-weight: 500;
        color: var(--text-primary);
        border-bottom: 2px solid var(--border-color);
    }
    .history-table td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
    }
    .history-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.02);
    }
    .buy-order {
        color: var(--accent-green);
        background: rgba(0, 200, 83, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 500;
    }
    .sell-order {
        color: var(--accent-red);
        background: rgba(255, 61, 87, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 500;
    }
    .profit-positive {
        color: var(--accent-green);
    }
    .profit-negative {
        color: var(--accent-red);
    }
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .summary-card {
        background: var(--bg-primary);
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    .summary-card-title {
        color: var(--text-primary);
        font-size: 14px;
        margin-bottom: 8px;
    }
    .summary-card-value {
        font-size: 24px;
        font-weight: 600;
        color: var(--text-primary);
    }
    .status-closed {
        color: var(--text-primary);
        background: rgba(160, 163, 189, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
    }
    @media (max-width: 1024px) {
        .history-table {
            display: block;
            overflow-x: auto;
        }
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="history-container">
    <div class="history-header">
        <h1 class="history-title">Order History</h1>
        <div class="history-actions">
            <button onclick="exportHistory()" style="background: var(--accent-blue); border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>

    <!-- Summary Cards Moved to Top -->
    <div class="summary-cards">
        <div class="summary-card">
            <div class="summary-card-title">Balance</div>
            <div class="summary-card-value">$10,319.97</div>
        </div>
        <div class="summary-card">
            <div class="summary-card-title">Deposit</div>
            <div class="summary-card-value">$0.00</div>
        </div>
        <div class="summary-card">
            <div class="summary-card-title">Withdraw</div>
            <div class="summary-card-value">$100.00</div>
        </div>
        <div class="summary-card">
            <div class="summary-card-title">Commission</div>
            <div class="summary-card-value">$0.00</div>
        </div>
        <div class="summary-card">
            <div class="summary-card-title">SWAP</div>
            <div class="summary-card-value">-$3.10</div>
        </div>
        <div class="summary-card">
            <div class="summary-card-title">Profit</div>
            <div class="summary-card-value" style="color: var(--accent-green);">$423.07</div>
        </div>
    </div>

    <!-- Add some spacing between cards and table -->
    <div style="margin-top: 30px;"></div>

    <!-- Order History Table -->
    <div class="history-table-container">
        <table class="history-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Time</th>
                    <th>Symbol</th>
                    <th>Type</th>
                    <th>Lot</th>
                    <th>Status</th>
                    <th>Entry</th>
                    <th>Exit</th>
                    <th>SL</th>
                    <th>TP</th>
                    <th>Commission</th>
                    <th>Profit</th>
                    <th>SWAP</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1594</td>
                    <td>2025-02-17 11:16:45</td>
                    <td>XAUUSD</td>
                    <td><span class="sell-order">SELL</span></td>
                    <td>0.5</td>
                    <td><span class="status-closed">closed</span></td>
                    <td>2901.07</td>
                    <td>2899.31</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td class="profit-positive">88</td>
                    <td>0</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    // Load trade history when page loads
    document.addEventListener('DOMContentLoaded', loadTradeHistory);

    async function loadTradeHistory() {
        try {
            const response = await fetch('/api/get_trade_history/');
            const data = await response.json();
            
            if (data.success) {
                updateTradeTable(data.trades);
                updateSummaryCards(data.summary);
            }
        } catch (error) {
            console.error('Error loading trade history:', error);
        }
    }

    function updateTradeTable(trades) {
        const tbody = document.querySelector('.history-table tbody');
        if (!trades || trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="13" style="text-align: center;">No trades found</td></tr>';
            return;
        }

        tbody.innerHTML = trades.map(trade => `
            <tr>
                <td>${trade.id}</td>
                <td>${formatDate(trade.time)}</td>
                <td>${trade.symbol}</td>
                <td><span class="${trade.type.toLowerCase()}-order">${trade.type}</span></td>
                <td>${trade.lot}</td>
                <td><span class="status-${trade.status.toLowerCase()}">${trade.status}</span></td>
                <td>${trade.entry}</td>
                <td>${trade.exit}</td>
                <td>${trade.sl}</td>
                <td>${trade.tp}</td>
                <td>${trade.commission}</td>
                <td class="${trade.profit >= 0 ? 'profit-positive' : 'profit-negative'}">${trade.profit}</td>
                <td>${trade.swap}</td>
            </tr>
        `).join('');
    }

    function updateSummaryCards(summary) {
        document.querySelector('.summary-card:nth-child(1) .summary-card-value').textContent = formatCurrency(summary.balance);
        document.querySelector('.summary-card:nth-child(2) .summary-card-value').textContent = formatCurrency(summary.deposit);
        document.querySelector('.summary-card:nth-child(3) .summary-card-value').textContent = formatCurrency(summary.withdraw);
        document.querySelector('.summary-card:nth-child(4) .summary-card-value').textContent = formatCurrency(summary.commission);
        document.querySelector('.summary-card:nth-child(5) .summary-card-value').textContent = formatCurrency(summary.swap);
        document.querySelector('.summary-card:nth-child(6) .summary-card-value').textContent = formatCurrency(summary.profit);
    }

    function formatDate(dateString) {
        return new Date(dateString).toLocaleString();
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    }

    function exportHistory() {
        // Implementation for exporting history to CSV
        const table = document.querySelector('.history-table');
        let csv = [];
        
        // Add headers
        const headers = Array.from(table.querySelectorAll('th'))
            .map(th => th.textContent.trim());
        csv.push(headers.join(','));
        
        // Add rows
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const rowData = Array.from(row.querySelectorAll('td'))
                .map(td => td.textContent.trim());
            csv.push(rowData.join(','));
        });
        
        // Create and download CSV file
        const csvContent = csv.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', 'trade_history.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>
{% endblock extra_js %}

